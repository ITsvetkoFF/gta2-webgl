<html>
<head>
<title>Gta2 web port</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style>
    body {
        font-family: Monospace;
        background-color: #f0f0f0;
        margin: 0px;
        overflow: hidden;
    }
</style>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="/jdataview.js" type="application/javascript"></script>
<script src="/mapParser.js" type="application/javascript"></script>
<script src="/styleParser.js" type="application/javascript"></script>
<script src="/three/build/three.min.js"></script>

<script src="/three/examples/js/libs/stats.min.js"></script>
<script src="/render.js"></script>
<script src="/getBinaryData.js" type="application/javascript"></script>


</head>

<body>
<script>
	var level;
	var style;
	var style = new Object();
	style.tiles = new Array();
	style.tiles[0] = new Image();
	
	var dummyTexture = new Image();
	
	dummyTexture.onload = function () {
	
		var loadTextures = true;
	
		if(!loadTextures) {
			for(i = 0;i < 1024;i++) {
				style.tiles[i] = dummyTexture;
			}
		}
	
		$(function () {
		    $("#statusmessage").text("Downloading map...");
			$("#progressbarContent").css("width", "10%");		
			
			var startDate = new Date();
         
			getBinaryData("http://localhost:8000/MP1-comp.gmp", LoadComplete);
			
			function LoadComplete(data, err)
			{
				
				$("#statusmessage").text("Parsing map...");
				$("#progressbarContent").css("width", "20%");
			
				var mapData = data.responseText;
				level = new ReadFromData(mapData);
				
				$("#statusmessage").text("Downloading styles...");
				$("#progressbarContent").css("width", "30%");
				
				getBinaryData("http://localhost:8000/bil.sty", StyleLoadComplete);
			}
			
			function StyleLoadComplete(data, err) {
				var styleData = data.responseText;
				console.log("Parsing styles...");
				$("#statusmessage").html("Parsing styles...");
				$("#progressbarContent").css("width", "50%");
				
				
				   setTimeout(function(){
						if(loadTextures) {
						    style = ParseStyle(styleData, getTileNumbers(level));
						}   
						
						$("#statusmessage").text("Initalizing game...");
						$("#progressbarContent").css("width", "80%");
						
						setTimeout(function(){
							init();
                        
							$("#loadingScreen").hide();
							
							var endDate = new Date();
							
							console.log("Loaded in "+(endDate.getTime()-startDate.getTime())/1000+"sec");
							animate();
						},10);
				    },10);
				
				
				
		
			
				/*for (var i = 20; i < 250; i++)
				{	
					for (var j = 20; j < 250; j++)
					{		
						for (var k = 3; k < 4; k++)
						{
							var block = level.map[i][j][k];
				
							if(block != undefined && block.Lid != undefined && block.Lid.tileNumber != undefined)
							{ 
								debugger;
								document.body.appendChild(style.tiles[block.Lid.tileNumber]);
							}
						}
					}
				}*/
			}
		});
		
	};
	
	dummyTexture.src = "http://localhost:8000/texture.jpg";

	function getTileNumbers(level) {
	    //Find unique tileNumbers (for selective loading)
	    var uniqueTileNumbers = [];
	    if (level) {
	        var temp = {};
	        for (var i = 0; i < level.map.length; i++) {
	            for (var ii = 0; ii < level.map[i].length; ii++) {
	                for (var iii = 0; iii < level.map[i][ii].length; iii++) {
	                    if (level.map[i][ii][iii] != undefined) {
	                        temp[level.map[i][ii][iii].Top.tileNumber] = true;
	                        temp[level.map[i][ii][iii].Left.tileNumber] = true;
	                        temp[level.map[i][ii][iii].Right.tileNumber] = true;
	                        temp[level.map[i][ii][iii].Bottom.tileNumber] = true;
	                        temp[level.map[i][ii][iii].Lid.tileNumber] = true;
	                    }
	                }
	            }
	        }

	        for (var k in temp)
	            uniqueTileNumbers.push(parseInt(k));
	    }

	    return uniqueTileNumbers;

	}
	
</script>

<div id="loadingScreen" style="position:absolute; width:100%; height:100%">
	<div id="statusmessage" style="position: absolute; top: 10%; width: 100%; text-align: center;"></div>
	<div id="progressbar" style="width: 250px; border: 1px solid #bbb; height:20px; margin:0 auto; margin-top:150px">
		<div id="progressbarContent" style="position:relative; height:100%; background:#ccc; width:0%"></div>
</div>

</div>
</body>

</html>